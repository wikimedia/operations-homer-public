family inet {
    {% if ping_offload_redirect | d(false)  %}
    /* T190090 */
    replace: filter transport-in4 {
        term no-offload-ping4 {
            from {
                destination-address {
                    {{ ping_offload_vip }};
                }
                source-prefix-list {
                    wikimedia4;
                    trusted-space4;
                }
                protocol icmp;
                icmp-type echo-request;
            }
            then accept;
        }
        term offload-ping4 {
            from {
                destination-address {
                    {{ ping_offload_vip }};
                }
                protocol icmp;
                icmp-type echo-request;
            }
            then {
                next-ip {{ ping_offload_redirect }}/32;
            }
        }
        term default {
            then accept;
        }
    }
    {% endif %}
    replace: filter border-in4 {
        /* T246618 */
        term sample {
            then {
                sample;
                next term;
            }
        }
        term special-ranges {
            from {
                prefix-list {
                    special-ranges4;
                }
            }
            then {
                count special-ranges-in;
                discard;
            }
        }
        term allow_peers4 {
            from {
                source-prefix-list {
                    bgp-sessions;
                }
            }
            then accept;
        }
        /* reject traffic spoofed with our own source addresses */
        term own-space {
            from {
                source-prefix-list {
                    wikimedia4;
                }
            }
            then {
                count own-space;
                discard;
            }
        }
        /* T226742 */
        term blackhole {
            from {
                source-prefix-list {
                    blackhole4;
                }
            }
            then {
                count blackhole;
                discard;
            }
        }
        /* explicitly allow Auth DNS traffic; would normally be discarded by the DDoS UDP term below */
        term authdns {
            from {
                destination-address {
                    91.198.174.239/32;
                    198.35.27.27/32;
                    208.80.154.238/32;
                    208.80.153.231/32;
                }
                protocol [ tcp udp ];
                port 53;
            }
            then accept;
        }
        /* explicitly allow SSH traffic; would normally be discarded by the protect-lvs term below */
        term phab-git-ssh {
            from {
                destination-address {
                    /* git-ssh.eqiad.wikimedia.org */
                    208.80.154.250/32;
                    /* git-ssh.codfw.wikimedia.org */
                    208.80.153.250/32;
                }
                protocol tcp;
                destination-port 22;
            }
            then accept;
        }
        term gre-lvs-ddos {
            from {
                destination-prefix-list {
                    LVS-service-ips;
                }
                protocol gre;
            }
            then {
                discard;
            }
        }
        term udp-lvs-ddos {
            from {
                destination-prefix-list {
                    LVS-service-ips;
                }
                protocol udp;
            }
            then {
                discard;
            }
        }
        term protect-lvs {
            from {
                destination-prefix-list {
                    LVS-service-ips;
                }
                protocol tcp;
                destination-port [ 22 179 9090 9100 ];
            }
            then {
                discard;
            }
        }
        /* RIPE Atlas wants access to 5666 which we block below */
        term ripe-atlas {
            from {
                destination-address {
                    208.80.155.69/32;
                    208.80.152.244/32;
                    198.35.26.244/32;
                    103.102.166.20/32;
                    91.198.174.132/32;
                }
            }
            then accept;
        }
        /* Temporary for mx1001 reimage T286911 */
        term mx1001 {
            from {
                destination-address {
                    208.80.154.76/32;
                }
                protocol tcp;
                destination-port 25;
            }
            then {
                discard;
            }
        }
        /* Temporary for T286911 */
        term mx2002 {
            from {
                destination-address {
                    208.80.153.72/32;
                }
                protocol tcp;
                destination-port 25;
            }
            then {
                discard;
            }
        }
        /* reject webproxy for extra protection, as it's a gateway to prod - T122368 */
        term webproxy {
            from {
                destination-address {
                    /* install1003 */
                    208.80.154.32/32;
                    /* install2003 */
                    208.80.153.51/32;
                }
                protocol tcp;
                destination-port [ 3128 8080 ];
            }
            then reject administratively-prohibited;
        }
        term nrpe {
            from {
                protocol tcp;
                destination-port 5666;
            }
            then {
                reject administratively-prohibited;
            }
        }
        /* T224186 */
        term icmp-first-frag {
            from {
                first-fragment;
                protocol icmp;
            }
            then {
                discard;
            }
        }
        term icmp-is-frag {
            from {
                is-fragment;
                protocol icmp;
            }
            then {
                discard;
            }
        }
        {% if ping_offload_redirect | d(false)  %}
        term offload-ping4 {
            from {
                destination-address {
                    {{ ping_offload_vip }};
                }
                protocol icmp;
                icmp-type echo-request;
            }
            then {
                next-ip {{ ping_offload_redirect }}/32;
            }
        }
        {% endif %}
        term default {
            then accept;
        }
    }
    replace: filter border-out4 {
        term special-ranges {
            from {
                prefix-list {
                    special-ranges4;
                }
            }
            then {
                count special-ranges-out;
                discard;
            }
        }
        term default {
            then {
                sample;
                accept;
            }
        }
    }
    replace: filter loopback4 {
        term allow_ssh4 {
            from {
                source-prefix-list {
                    production4;
                    private4;
                    trusted-space4;
                }
                protocol tcp;
                destination-port ssh;
            }
            then accept;
        }
        term allow_bgp4 {
            from {
                source-prefix-list {
                    bgp-sessions;
                }
                protocol tcp;
                port bgp;
            }
            then accept;
        }
        term allow_ospf4 {
            from {
                protocol ospf;
            }
            then accept;
        }
        term allow_snmp4 {
            from {
                source-prefix-list {
                    production4;
                    private4;
                    trusted-space4;
                }
                protocol udp;
                destination-port snmp;
            }
            then accept;
        }
        term allow_ntp4 {
            from {
                source-prefix-list {
                    production4;
                }
                protocol udp;
                destination-port ntp;
            }
            then accept;
        }
        term allow_ok_icmp4 {
            from {
                protocol icmp;
                icmp-type [ echo-request echo-reply unreachable time-exceeded source-quench ];
            }
            then {
                policer policer-2m;
                accept;
            }
        }
        term allow_vrrp4 {
            from {
                destination-address {
                    224.0.0.18/32;
                }
            }
            then accept;
        }
        /* discovery from the host to the relay */
        term allow_dhcp_request4 {
            from {
                source-address {
                    0.0.0.0/32;
                }
                destination-address {
                    255.255.255.255/32;
                }
                protocol udp;
                source-port bootpc;
                destination-port bootps;
            }
            then accept;
        }
        /* reply from the DHCP server back to the relay */
        term allow_dhcp_reply4 {
            from {
                source-prefix-list {
                    production4;
                }
                protocol udp;
                source-port bootps;
                destination-port bootps;
            }
            then accept;
        }
        term allow_bfd4 {
            from {
                protocol udp;
                port 3784-3785;
            }
            then accept;
        }
        /* T209989 */
        term allow_mbfd4 {
            from {
                source-prefix-list {
                    bgp-sessions;
                }
                protocol udp;
                port 4784;
            }
            then accept;
        }
        term allow_dns4 {
            from {
                source-address {
                    10.3.0.1/32;
                }
                protocol udp;
                source-port domain;
            }
            then accept;
        }
        term allow_junos_upgrades4 {
            from {
                source-address {
                    /* install1003 */
                    208.80.154.32/32;
                    /* install2003 */
                    208.80.153.51/32;
                }
                protocol tcp;
                source-port 80;
            }
            then accept;
        }
        /* T236598, PR1179822 */
        term allow_vmhost {
            from {
                source-address {
                    192.168.1.0/24;
                }
                destination-address {
                    192.168.1.0/24;
                }
            }
            then accept;
        }
        term return-tcp {
            from {
                source-prefix-list {
                    production4;
                }
                protocol tcp;
                tcp-established;
            }
            then accept;
        }
        term deny_all {
            then {
                discard;
            }
        }
    }
    replace: filter sandbox4 {
        term no-private {
            from {
                prefix-list {
                    private4;
                }
            }
            then {
                discard;
            }
        }
        term dns {
            from {
                protocol udp;
                destination-port 53;
            }
            then accept;
        }
        term vrrp {
            from {
                protocol [ vrrp ah ];
            }
            then accept;
        }
        term dhcp {
            from {
                protocol udp;
                destination-port dhcp;
            }
            then accept;
        }
        term icmp {
            from {
                protocol icmp;
            }
            then accept;
        }
        term reject_other_WMF_space {
            from {
                destination-prefix-list {
                    wikimedia4;
                }
            }
            then {
                discard;
            }
        }
        term allow_rest {
            then accept;
        }
    }
    {% if metadata['site'] == "eqiad" %}
    replace: filter labs-in4 {
        term allow-vrrp {
            from {
                destination-address {
                    224.0.0.18/32;
                }
                protocol [ vrrp ah ];
            }
            then accept;
        }
        /* T268176 */
        term elk-kafka-logstash {
            from {
                source-address {
                    /* cloud-hosts1-b-eqiad */
                    10.64.20.0/24;
                    /* cloud-hosts1-b-codfw */
                    10.192.20.0/24;
                }
                destination-address {
                    /* logstash1010 */
                    10.64.0.181;
                    /* logstash1011 */
                    10.64.16.30;
                    /* logstash1012 */
                    10.64.48.177;
                    /* logstash2001 */
                    10.192.0.112;
                    /* logstash2002 */
                    10.192.32.180;
                    /* logstash2003 */
                    10.192.48.131;
                    /* kafka-logging1001 */
                    10.64.16.205/32;
                    /* kafka-logging1002 */
                    10.64.32.142/32;
                    /* kafka-logging1003 */
                    10.64.48.66/32;
                    /* kafka-logging2001 */
                    10.192.0.94/32;
                    /* kafka-logging2002 */
                    10.192.16.50/32;
                    /* kafka-logging2003 */
                    10.192.32.24/32;
                }
                protocol tcp;
                destination-port 9093;
            }
            then accept;
        }
        /* T190424 */
        term pxeboot--http {
            from {
                source-address {
                    10.64.20.0/24;
                }
                destination-address {
                    208.80.154.32/32;
                    208.80.153.51/32;
                }
                protocol tcp;
                destination-port 80;
            }
            then accept;
        }
        term ttl-check {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    10.64.20.0/24;
                }
                ttl-except 64;
            }
            then {
                count ttl-check;
                discard;
            }
        }
        term allow-labs {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    10.64.20.0/24;
                }
                destination-address {
                    /* labs-support1-a-eqiad */
                    10.64.4.0/24;
                    /* labs-support1-c-eqiad */
                    10.64.37.0/24;
                }
            }
            then accept;
        }
        term allow-labs-instances {
            from {
                destination-address {
                    /* labs-instances1-b-eqiad */
                    10.68.16.0/21;
                }
            }
            then accept;
        }
        term allow-anycast-dns {
            from {
                destination-address {
                    /* recdns.anycast */
                    10.3.0.1/32;
                }
                protocol [ tcp udp ];
                destination-port 53;
            }
            then accept;
        }
        term puppetmaster {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    10.64.20.0/24;
                }
                destination-address {
                    /* puppetmaster1001 */
                    10.64.16.73/32;
                    /* puppetmaster2001 */
                    10.192.0.27/32;
                }
                protocol tcp;
                destination-port 8140;
            }
            then accept;
        }
        term prometheus {
            from {
                destination-address {
                    /* prometheus1003 */
                    10.64.0.123/32;
                    /* prometheus1004 */
                    10.64.16.38/32;
                    /* prometheus2003 */
                    10.192.0.145/32;
                    /* prometheus2004 */
                    10.192.16.189/32;
                }
                protocol tcp;
                source-port [ 9100 9105 ];
            }
            then accept;
        }
        term cumin {
            from {
                source-address {
                    10.64.20.0/24;
                }
                destination-address {
                    /* cumin1001 */
                    10.64.32.25/32;
                    /* cumin2001 */
                    10.192.48.16/32;
                    /* cumin2002 */
                    10.192.32.49/32;
                }
                protocol tcp;
                source-port 22;
            }
            then accept;
        }
        /* T269457 */
        term cloudcontrol {
            from {
                destination-address {
                    /* cloudcontrol2001-dev */
                    208.80.153.59/32;
                    /* cloudcontrol2003-dev */
                    208.80.153.75/32;
                    /* cloudcontrol2004-dev */
                    208.80.153.116/32;
                }
            }
            then accept;
        }
        /* T261489 */
        term debmonitor {
            from {
                source-address {
                    10.64.20.0/24;
                }
                destination-address {
                    /* debmonitor1002 */
                    10.64.16.72/32;
                    /* debmonitor2002 */
                    10.192.32.42/32;
                }
                protocol tcp;
                destination-port 443;
            }
            then accept;
        }
        term allow_syslog {
            from {
                destination-address {
                    /* lithium */
                    10.64.32.154/32;
                    /* centrallog1001 */
                    10.64.48.113/32;
                    /* wezen */
                    10.192.48.64/32;
                }
                protocol udp;
                destination-port 514;
            }
            then accept;
        }
        term allow_syslog-tls {
            from {
                destination-address {
                    /* lithium */
                    10.64.32.154/32;
                    /* centrallog1001 */
                    10.64.48.113;
                    /* wezen */
                    10.192.48.64/32;
                }
                protocol tcp;
                destination-port 6514;
            }
            then accept;
        }
        term allow_graphite {
            from {
                source-address {
                    10.64.20.0/24;
                }
                destination-port [ 2003 2004 8125 ];
            }
            then accept;
        }
        term phab-git-ssh {
            from {
                destination-address {
                    /* git-ssh.eqiad.wikimedia.org */
                    208.80.154.250/32;
                    /* git-ssh.codfw.wikimedia.org */
                    208.80.153.250/32;
                }
                protocol tcp;
                destination-port 22;
            }
            then accept;
        }
        term no_ssh_public4 {
            from {
                destination-prefix-list {
                    wikimedia4;
                }
                destination-port ssh;
                tcp-initial;
            }
            then {
                reject;
            }
        }
        term inf-use-proxy {
            from {
                source-address {
                    10.64.20.0/24;
                }
                destination-address {
                    /* install1003 */
                    208.80.154.32/32;
                    /* install2003 */
                    208.80.153.51/32;
                }
                protocol tcp;
                destination-port [ 3128 8080 ];
            }
            then accept;
        }
        term pki {
            from {
                source-address {
                    10.64.20.0/24;
                }
                destination-address {
                    /* pki1001.eqiad.wment */
                    10.64.0.10/32;
                    /* pki2001.codfw.wment */
                    10.192.0.35/32;
                }
                protocol tcp;
                destination-port [ 80 443 ];
            }
            then accept;
        }
        term instance-traffic {
            filter labs-instance-in4;
        }
        /* Deny any communication with private subnets */
        term deny-private-subnets {
            from {
                destination-prefix-list {
                    private4;
                }
            }
            then {
                count deny-private-subnets4;
                reject administratively-prohibited;
            }
        }
        /* reject webproxy for extra protection, as it's a gateway to prod - T122368 */
        term webproxy {
            from {
                destination-address {
                    /* install1003 */
                    208.80.154.32/32;
                    /* install2003 */
                    208.80.153.51/32;
                }
                protocol tcp;
                destination-port [ 3128 8080 ];
            }
            then reject administratively-prohibited;
        }
        /* Allow communication to public subnets and the Internet */
        term default {
            then accept;
        }
    }
    /* Traffic from Labs instances can allow specifics here */
    replace: filter labs-instance-in4 {
        term labstore {
            from {
                destination-address {
                    /* nfs-tools-project.svc */
                    10.64.37.18/32;
                }
                protocol [ tcp udp ];
                port [ 38465-38567 55659 44153 111 2049 ];
            }
            then accept;
        }
        term wiki-replicas-tcp4 {
            from {
                destination-address {
                    /* dbproxy1019 */
                    10.64.37.28/32;
                    /* dbproxy1018 */
                    10.64.37.27/32;
                }
                protocol tcp;
                port [ 3306-3309 5432 873 ];
            }
            then accept;
        }
        term cloudmetrics {
            from {
                destination-address {
                    /* cloudmetrics1002 */
                    10.64.4.15/32;
                    /* cloudmetrics1001 */
                    10.64.37.13/32;
                }
                protocol [ tcp udp ];
                destination-port [ 80 8125 2003 2004 ];
            }
            then accept;
        }
       term relforge {
           from {
               destination-address {
                   10.64.4.13/32;
                   10.64.37.21/32;
               }
               protocol tcp;
               destination-port 9243;
           }
           then accept;
       }
    }
    {% endif %}
    /* T244147 */
    replace: filter sample-drop4 {
        term default {
            then {
                sample;
                discard;
            }
        }
    }
}
family inet6 {
    replace: filter border-in6 {
        /* T246618 */
        term sample {
            then {
                sample;
                next term;
            }
        }
        term special-ranges {
            from {
                prefix-list {
                    special-ranges6;
                }
            }
            then {
                count special-ranges-in;
                discard;
            }
        }
        term allow_peers6 {
            from {
                source-prefix-list {
                    bgp-sessions;
                }
            }
            then accept;
        }
        /* T226742 */
        term blackhole {
            from {
                source-prefix-list {
                    blackhole6;
                }
            }
            then {
                count blackhole;
                discard;
            }
        }
        /* Deny outside traffic to our private IPv6 ranges */
        term our-private {
            from {
                destination-prefix-list {
                    private6;
                }
            }
            then {
                reject administratively-prohibited;
            }
        }
        /* reject traffic spoofed with our own source addresses */
        term own-space {
            from {
                source-prefix-list {
                    wikimedia6;
                }
            }
            then {
                count own-space;
                discard;
            }
        }
        term udp-lvs-ddos {
            from {
                destination-prefix-list {
                    LVS-service-ips6;
                }
                next-header udp;
            }
            then {
                discard;
            }
        }
        /* explicitly allow SSH traffic; would normally be discarded by the protect-lvs term below */
        term phab-git-ssh {
            from {
                destination-address {
                    /* git-ssh.eqiad.wikimedia.org */
                    2620:0:861:ed1a::3:16/128;
                    /* git-ssh.codfw.wikimedia.org */
                    2620:0:860:ed1a::3:fa/128;
                }
                next-header tcp;
                destination-port 22;
            }
            then accept;
        }
        term gre-lvs-ddos {
            from {
                destination-prefix-list {
                    LVS-service-ips6;
                }
                next-header gre;
            }
            then discard;
        }
        term protect-lvs {
            from {
                destination-prefix-list {
                    LVS-service-ips6;
                }
                next-header tcp;
                destination-port [ 22 179 9090 9100 ];
            }
            then {
                discard;
            }
        }
        /* RIPE Atlas wants access to 5666 which we block below */
        term ripe-atlas {
            from {
                destination-address {
                    2620:0:861:202:208:80:155:69/128;
                    2620:0:860:201:208:80:152:244/128;
                    2620:0:863:201:198:35:26:244/128;
                    2001:df2:e500:201:103:102:166:20/128;
                    2620:0:862:201:91:198:174:132/128;
                }
            }
            then accept;
        }
        /* Temporary for T286911 */
        term mx2002 {
            from {
                destination-address {
                    2620:0:860:3:208:80:153:72/128;
                }
                next-header tcp;
                destination-port 25;
            }
            then {
                discard;
            }
        }
        /* reject webproxy for extra protection, as it's a gateway to prod - T122368 */
        term webproxy {
            from {
                destination-address {
                    /* install1003 */
                    2620:0:861:1:208:80:154:32;
                    /* install2003 */
                    2620:0:860:2:208:80:153:51;
                }
                next-header tcp;
                destination-port [ 3128 8080 ];
            }
            then reject administratively-prohibited;
        }
        term nrpe {
            from {
                next-header tcp;
                destination-port 5666;
            }
            then {
                reject administratively-prohibited;
            }
        }
        term default {
            then accept;
        }
    }
    replace: filter border-out6 {
        term special-ranges {
            from {
                prefix-list {
                    special-ranges6;
                }
            }
            then {
                count special-ranges-out;
                discard;
            }
        }
        /* Deny outgoing traffic from private IPv6 ranges */
        term private {
            from {
                source-prefix-list {
                    private6;
                }
            }
            then {
                reject administratively-prohibited;
            }
        }
        term default {
            then {
                sample;
                accept;
            }
        }
    }
    replace: filter loopback6 {
        term allow_ssh6 {
            from {
                source-prefix-list {
                    production6;
                    private6;
                    trusted-space6;
                }
                next-header tcp;
                destination-port ssh;
            }
            then accept;
        }
        term allow_bgp6 {
            from {
                source-prefix-list {
                    bgp-sessions;
                }
                next-header tcp;
                port bgp;
            }
            then accept;
        }
        term allow_ospf6 {
            from {
                next-header ospf;
            }
            then accept;
        }
        term allow_snmp6 {
            from {
                source-prefix-list {
                    production6;
                    private6;
                    trusted-space6;
                }
                next-header tcp;
                destination-port snmp;
            }
        }
        term allow_ntp6 {
            from {
                source-prefix-list {
                    production6;
                }
                next-header udp;
                destination-port ntp;
            }
            then accept;
        }
        term allow_ok_icmp6 {
            from {
                next-header icmpv6;
            }
            then accept;
        }
        term allow_vrrp6 {
            from {
                next-header vrrp;
            }
            then accept;
        }
        term allow_bfd6 {
            from {
                next-header udp;
                port 3784-3785;
            }
            then accept;
        }
        term return-tcp {
            from {
                source-prefix-list {
                    production6;
                }
                next-header tcp;
                tcp-established;
            }
            then accept;
        }
        term deny_other {
            then discard;
        }
    }
    replace: filter sandbox6 {
        term no-private {
            from {
                prefix-list {
                    private6;
                }
            }
            then discard;
        }
        term dns {
            from {
                next-header udp;
                destination-port 53;
            }
            then accept;
        }
        term vrrp {
            from {
                next-header [ vrrp ah ];
            }
            then accept;
        }
        term icmp {
            from {
                next-header icmp6;
            }
            then accept;
        }
        term reject_other_WMF_space {
            from {
                destination-prefix-list {
                    wikimedia6;
                }
            }
            then discard;
        }
        term allow_rest {
            then accept;
        }
    }
    {% if metadata['site'] == "eqiad" %}
    replace: filter labs-in6 {
        term allow_vrrp6 {
            from {
                next-header vrrp;
            }
            then accept;
        }
        term cumin {
            from {
                source-address {
                    /* cloud-hosts1-b-eqiad */
                    2620:0:861:118::/64;
                    /* cloud-hosts1-b-codfw */
                    2620:0:860:118::/64;
                }
                destination-address {
                    /* cumin1001 */
                    2620:0:861:103:10:64:32:25;
                    /* cumin2001 */
                    2620:0:860:104:10:192:48:16;
                    /* cumin2002 */
                    2620:0:860:103:10:192:32:49;
                }
                next-header tcp;
                source-port 22;
            }
            then accept;
        }

        /* T268176 */
        term elk-kafka-logstash {
            from {
                source-address {
                    /* cloud-hosts1-b-eqiad */
                    2620:0:861:118::/64;
                    /* cloud-hosts1-b-codfw */
                    2620:0:860:118::/64;
                }
                destination-address {
                    /* logstash1010 */
                    2620:0:861:101:10:64:0:181;
                    /* logstash1011 */
                    2620:0:861:102:10:64:16:30;
                    /* logstash1012 */
                    2620:0:861:107:10:64:48:177;
                    /* logstash2001 */
                    2620:0:860:101:10:192:0:112;
                    /* logstash2002 */
                    2620:0:860:103:10:192:32:180;
                    /* logstash2003 */
                    2620:0:860:104:10:192:48:131;
                    /* kafka-logging1001 */
                    2620:0:861:102:10:64:16:205/128;
                    /* kafka-logging1002 */
                    2620:0:861:103:10:64:32:142/128;
                    /* kafka-logging1003 */
                    2620:0:861:107:10:64:48:66/128;
                    /* kafka-logging2001 */
                    2620:0:860:101:10:192:0:94/128;
                    /* kafka-logging2002 */
                    2620:0:860:102:10:192:16:50/128;
                    /* kafka-logging2003 */
                    2620:0:860:103:10:192:32:24/128;
                }
                next-header tcp;
                destination-port 9093;
            }
            then accept;
        }
        /* T269457 */
        term cloudcontrol {
            from {
                destination-address {
                    /* cloudcontrol2001-dev */
                    2620:0:860:2:208:80:153:59/128;
                    /* cloudcontrol2003-dev */
                    2620:0:860:3:208:80:153:75/128;
                    /* cloudcontrol2004-dev */
                    2620:0:860:4:208:80:153:116/128;
                }
            }
            then accept;
        }
        inactive: term ttl-check {
            from {
                source-address {
                    2620:0:861:118::/64;
                }
                hop-limit-except 64;
            }
            then {
                count ttl-check;
                discard;
            }
        }
        term allow-labs {
            from {
                source-address {
                    2620:0:861:118::/64;
                }
                destination-address {
                    2620:0:861:117::/64;
                    2620:0:861:118::/64;
                    2620:0:861:119::/64;
                }
            }
            then accept;
        }
        term puppetmaster {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    2620:0:861:118::/64;
                }
                destination-address {
                    /* puppetmaster1001 */
                    2620:0:861:102:10:64:16:73/128;
                    /* puppetmaster2001 */
                    2620:0:860:101:10:192:0:27/128;
                }
                next-header tcp;
                destination-port 8140;
            }
            then accept;
        }
        term phab-git-ssh {
            from {
                destination-address {
                    /* git-ssh.eqiad.wikimedia.org */
                    2620:0:861:ed1a::3:16/128;
                    /* git-ssh.codfw.wikimedia.org */
                    2620:0:860:ed1a::3:fa/128;
                }
                next-header tcp;
                destination-port 22;
            }
            then accept;
        }
        term prometheus {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    2620:0:861:118::/64;
                }
                destination-address {
                    /* prometheus1003 */
                    2620:0:861:101:10:64:0:123/128;
                    /* prometheus1004 */
                    2620:0:861:102:10:64:16:38/128;
                    /* prometheus2003 */
                    2620:0:860:101:10:192:0:145/128;
                    /* prometheus2004 */
                    2620:0:860:102:10:192:16:189/128;
                }
                next-header tcp;
                source-port [ 9100 9105 ];
            }
            then accept;
        }
        term pki {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    2620:0:861:118::/64;
                }
                destination-address {
                    /* pki1001.eqiad.wmnet */
                    2620:0:861:101:10:64:0:10/128;
                    /* pki2001.codfw.wmnet */
                    2620:0:860:101:10:192:0:35/128;
                }
                next-header tcp;
                destination-port [ 80 443 ];
            }
            then accept;
        }
        term no_ssh_public6 {
            from {
                destination-prefix-list {
                    wikimedia6;
                }
                next-header tcp;
                destination-port ssh;
                tcp-initial;
            }
            then {
                reject;
            }
        }
        /* Deny any communication with private subnets */
        term deny-private-subnets {
            from {
                destination-prefix-list {
                    private6;
                }
            }
            then {
                count deny-private-subnets-in6;
                log;
                reject administratively-prohibited;
            }
        }
        /* Allow communication to public subnets and the Internet */
        term default {
            then accept;
        }
    }
    {% endif %}
    /* T244147 */
    replace: filter sample-drop6 {
        term default {
            then {
                sample;
                discard;
            }
        }
    }
}
policer policer-1m {
    if-exceeding {
        bandwidth-limit 1m;
        burst-size-limit 100k;
    }
    then discard;
}
policer policer-2m {
    if-exceeding {
        bandwidth-limit 2m;
        burst-size-limit 500k;
    }
    then discard;
}
