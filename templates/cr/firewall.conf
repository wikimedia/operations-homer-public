family inet {
    {% if site == "eqiad" or site == "codfw"  %}
    /* T190090 */
    filter transport-in4 {
        term no-offload-ping4 {
            from {
                destination-address {
                    {{ ping_offload_vip }};
                }
                source-prefix-list {
                    wikimedia4;
                    trusted-space4;
                }
                protocol icmp;
                icmp-type echo-request;
            }
            then accept;
        }
        term offload-ping4 {
            from {
                destination-address {
                    {{ ping_offload_vip }};
                }
                protocol icmp;
                icmp-type echo-request;
            }
            then {
                next-ip {{ ping_offload_redirect }}/32;
            }
        }
        term default {
            then accept;
        }
    }
    {% endif %}
    filter border-in4 {
        term special-ranges {
            from {
                prefix-list {
                    special-ranges4;
                }
            }
            then {
                count special-ranges-in;
                discard;
            }
        }
        term allow_peers4 {
            from {
                source-prefix-list {
                    bgp-sessions;
                }
            }
            then accept;
        }
        /* reject traffic spoofed with our own source addresses */
        term own-space {
            from {
                source-prefix-list {
                    wikimedia4;
                }
            }
            then {
                count own-space;
                discard;
            }
        }
        term lvs-blackhole {
            from {
                source-prefix-list {
                    blackhole4;
                }
                destination-prefix-list {
                    LVS-service-ips;
                }
            }
            then {
                discard;
            }
        }
        /* explicitly allow Auth DNS traffic; would normally be discarded by the DDoS UDP term below */
        term authdns {
            from {
                destination-address {
                    91.198.174.239/32;
                    208.80.154.238/32;
                    208.80.153.231/32;
                }
                protocol [ tcp udp ];
                port 53;
            }
            then accept;
        }
        /* explicitly allow SSH traffic; would normally be discarded by the protect-lvs term below */
        term phab-git-ssh {
            from {
                destination-address {
                    /* git-ssh.eqiad.wikimedia.org */
                    208.80.154.250/32;
                    /* git-ssh.codfw.wikimedia.org */
                    208.80.153.250/32;
                }
                protocol tcp;
                destination-port 22;
            }
            then accept;
        }
        term gre-lvs-ddos {
            from {
                destination-prefix-list {
                    LVS-service-ips;
                }
                protocol gre;
            }
            then {
                discard;
            }
        }
        term udp-lvs-ddos {
            from {
                destination-prefix-list {
                    LVS-service-ips;
                }
                protocol udp;
            }
            then {
                discard;
            }
        }
        term protect-lvs {
            from {
                destination-prefix-list {
                    LVS-service-ips;
                }
                protocol tcp;
                destination-port [ 22 179 9090 9100 ];
            }
            then {
                discard;
            }
        }
        /* RIPE Atlas wants access to 5666 which we block below */
        term ripe-atlas {
            from {
                destination-address {
                    208.80.155.69/32;
                    208.80.152.244/32;
                    198.35.26.244/32;
                    103.102.166.20/32;
                    91.198.174.132/32;
                }
            }
            then accept;
        }
        /* reject webproxy for extra protection, as it's a gateway to prod - T122368 */
        term webproxy {
            from {
                destination-address {
                    /* install1002 */
                    208.80.154.22/32;
                    /* install2002 */
                    208.80.153.53/32;
                }
                protocol tcp;
                destination-port [ 3128 8080 ];
            }
            then reject administratively-prohibited;
        }
        term nrpe {
            from {
                protocol tcp;
                destination-port 5666;
            }
            then {
                reject administratively-prohibited;
            }
        }
        /* T224186 */
        term icmp-first-frag {
            from {
                first-fragment;
                protocol icmp;
            }
            then {
                discard;
            }
        }
        term icmp-is-frag {
            from {
                is-fragment;
                protocol icmp;
            }
            then {
                discard;
            }
        }
        {% if site == "eqiad" or site == "codfw"  %}
        term offload-ping4 {
            from {
                destination-address {
                    {{ ping_offload_vip }};
                }
                protocol icmp;
                icmp-type echo-request;
            }
            then {
                next-ip {{ ping_offload_redirect }}/32;
            }
        }
        {% endif %}
        term default {
            then accept;
        }
    }
    filter border-out4 {
        term special-ranges {
            from {
                prefix-list {
                    special-ranges4;
                }
            }
            then {
                count special-ranges-out;
                discard;
            }
        }
        term default {
            then accept;
        }
    }
    filter deny-private-subnets-in4 {
        /* Deny any communication with private subnets */
        term deny-private-subnets {
            from {
                destination-prefix-list {
                    private4;
                }
            }
            then {
                count deny-private-subnets4;
                reject administratively-prohibited;
            }
        }
        /* reject webproxy for extra protection, as it's a gateway to prod - T122368 */
        term webproxy {
            from {
                destination-address {
                    /* install1002 */
                    208.80.154.22/32;
                    /* install2002 */
                    208.80.153.53/32;
                }
                protocol tcp;
                destination-port [ 3128 8080 ];
            }
            then reject administratively-prohibited;
        }
        /* Allow communication to public subnets and the Internet */
        term default {
            then accept;
        }
    }
    filter loopback4 {
        term allow_ssh4 {
            from {
                source-prefix-list {
                    wikimedia4;
                    private4;
                    trusted-space4;
                }
                protocol tcp;
                destination-port ssh;
            }
            then accept;
        }
        term allow_bgp4 {
            from {
                source-prefix-list {
                    bgp-sessions;
                }
                protocol tcp;
                port bgp;
            }
            then accept;
        }
        term allow_ospf4 {
            from {
                protocol ospf;
            }
            then accept;
        }
        term allow_snmp4 {
            from {
                source-prefix-list {
                    wikimedia4;
                    private4;
                    trusted-space4;
                }
                protocol udp;
                destination-port snmp;
            }
            then accept;
        }
        term allow_ntp4 {
            from {
                source-prefix-list {
                    wikimedia4;
                }
                protocol udp;
                destination-port ntp;
            }
            then accept;
        }
        term allow_ok_icmp4 {
            from {
                protocol icmp;
                icmp-type [ echo-request echo-reply unreachable time-exceeded source-quench ];
            }
            then {
                policer policer-2m;
                accept;
            }
        }
        term allow_vrrp4 {
            from {
                destination-address {
                    224.0.0.18/32;
                }
            }
            then accept;
        }
        term allow_pim4 {
            from {
                protocol pim;
            }
            then accept;
        }
        term allow_igmp4 {
            from {
                protocol igmp;
            }
            then accept;
        }
        term allow_dhcp4 {
            from {
                destination-port [ bootpc dhcp ];
            }
            then accept;
        }
        term allow_bfd4 {
            from {
                protocol udp;
                port 3784-3785;
            }
            then accept;
        }
        /* T209989 */
        term allow_mbfd4 {
            from {
                source-prefix-list {
                    bgp-sessions;
                }
                protocol udp;
                port 4784;
            }
            then accept;
        }
        term allow_dns4 {
            from {
                source-prefix-list {
                    wikimedia4;
                }
                protocol udp;
                source-port domain;
            }
            then accept;
        }
        term allow_junos_upgrades4 {
            from {
                source-address {
                    /* install1002 */
                    208.80.154.22/32;
                    /* install2002 */
                    208.80.153.53/32;
                }
                protocol tcp;
                source-port 80;
            }
            then accept;
        }
        term return-tcp {
            from {
                source-prefix-list {
                    wikimedia4;
                }
                protocol tcp;
                tcp-established;
            }
            then accept;
        }
        term deny_all {
            then {
                discard;
            }
        }
    }
    {% if site == "eqiad" %}
    /* Applied to traffic going out of the analytics vlans. Last audit in T198623. */
    filter analytics-in4 {
      interface-specific;
      term udp-frag {
          from {
              fragment-offset 1-8191;
              protocol udp;
          }
          then accept;
      }
      term puppet {
          from {
              destination-address {
                  /* puppetmaster1001 */
                  10.64.16.73/32;
                  /* puppetmaster1002 */
                  10.64.48.45/32;
                  /* puppetmaster2001 */
                  10.192.0.27/32;
              }
              protocol tcp;
              destination-port 8140;
          }
          then accept;
      }
      term apt {
          from {
              destination-address {
                  /* install2002 */
                  208.80.153.53/32;
                  /* install1002 */
                  208.80.154.22/32;
              }
              protocol tcp;
              destination-port 80;
          }
          then accept;
      }
      term webproxy {
          from {
              destination-address {
                  /* install2002 */
                  208.80.153.53/32;
                  /* install1002 */
                  208.80.154.22/32;
              }
              protocol tcp;
              destination-port 8080;
          }
          then accept;
      }
      term dns {
          from {
              protocol udp;
              destination-port 53;
          }
          then accept;
      }
      term ntp {
          from {
              protocol udp;
              destination-port 123;
          }
          then accept;
      }
      term smtp {
          from {
              protocol tcp;
              destination-port 25;
          }
          then accept;
      }
      term icinga {
          from {
              destination-address {
                  /* icinga2001 */
                  208.80.153.74/32;
                  /* icinga1001 */
                  208.80.154.84/32;
              }
          }
          then accept;
      }
      term igmp {
          from {
              protocol igmp;
          }
          then accept;
      }
      term ldap {
          from {
              destination-address {
                  /* serpens */
                  208.80.153.49/32;
                  /* seaborgium */
                  208.80.154.79/32;
              }
              protocol tcp;
              destination-port [ 389 636 ];
          }
          then accept;
      }
      term pim {
          from {
              destination-address {
                  224.0.0.13/32;
              }
              protocol pim;
          }
          then accept;
      }
      term tftp {
          from {
              destination-address {
                  /* install2002 */
                  208.80.153.53/32;
                  /* install1002 */
                  208.80.154.22/32;
              }
              protocol udp;
              destination-port [ 69 32768-61000 ];
          }
          then accept;
      }
      term vrrp {
          from {
              protocol [ vrrp ah ];
          }
          then accept;
      }
      term dhcp {
          from {
              protocol udp;
              destination-port 67-68;
          }
          then accept;
      }
      term analytics-subnets {
          from {
              destination-address {
                  /* analytics1-a-eqiad */
                  10.64.5.0/24;
                  /* analytics1-b-eqiad */
                  10.64.21.0/24;
                  /* analytics1-c-eqiad */
                  10.64.36.0/24;
                  /* analytics1-d-eqiad */
                  10.64.53.0/24;
              }
          }
          then accept;
      }
      term analytics-publicIP {
          from {
              destination-address {
                  /* labstore1006 */
                  208.80.154.7/32;
                  /* dataset1001 */
                  208.80.154.11/32;
                  /* install1002 */
                  208.80.154.22/32;
                  /* labstore1007 */
                  208.80.155.106/32;
              }
          }
          then accept;
      }
      term graphite {
          from {
              destination-address {
                  /* graphite1004 */
                  10.64.16.149/32;
                  /* graphite1001 */
                  10.64.32.155/32;
                  /* graphite2003 */
                  10.192.0.102/32;
                  /* graphite2001 */
                  10.192.16.33/32;
              }
              protocol [ tcp udp ];
              destination-port 2003;
          }
          then accept;
      }
      term statsd {
          from {
              destination-address {
                  /* graphite1004 */
                  10.64.16.149/32;
                  /* graphite1001 */
                  10.64.32.155/32;
                  /* graphite2003 */
                  10.192.0.102/32;
                  /* graphite2001 */
                  10.192.16.33/32;
              }
              protocol udp;
              destination-port 8125;
          }
          then accept;
      }
      term mysql-dbstore {
          from {
              destination-address {
                  /* dbstore1003 */
                  10.64.0.137/32;
                  /* dbstore1004 */
                  10.64.16.26/32;
                  /* dbstore1005 */
                  10.64.32.30/32;
              }
              protocol tcp;
              destination-port [ 3311-3318 3320 3350 ];
          }
          then accept;
      }
      term mysql {
          from {
              destination-address {
                  /* labsdb1012 */
                  10.64.4.16/32;
                  /* db1108 */
                  10.64.32.71/32;
                  /* dbproxy1010, dbproxy1011 */
                  10.64.37.14/31;
                  /* dbstore1002 */
                  10.64.48.18/32;
              }
              protocol tcp;
              destination-port 3306;
          }
          then accept;
      }
      term ssh {
          from {
              destination-address {
                  /* dbstore1002 */
                  10.64.48.18/32;
                  /* dubnium */
                  208.80.154.13/32;
                  /* sodium */
                  208.80.154.15/32;
                  /* aluminium, cobalt */
                  208.80.154.80/31;
              }
              protocol tcp;
              destination-port 22;
          }
          then accept;
      }
      term rsync-http-https {
          from {
              destination-address {
                  /* ms-be1028 */
                  10.64.0.21/32;
                  /* mwlog1001 */
                  10.64.32.175/32;
                  /* dbstore1002 */
                  10.64.48.18/32;
                  /* eventlog1002 */
                  10.64.48.95/32;
                  /* mwlog2001 */
                  10.192.32.131/32;
                  /* dubnium */
                  208.80.154.13/32;
                  /* sodium */
                  208.80.154.15/32;
                  /* aluminium, cobalt */
                  208.80.154.80/31;
              }
              protocol tcp;
              destination-port [ 80 443 873 ];
          }
          then accept;
      }
      term return-tcp {
          from {
              protocol tcp;
              tcp-established;
          }
          then accept;
      }
      term kafka {
          from {
              destination-address {
                  /* kafka1001 */
                  10.64.0.11/32;
                  /* kafka-jumbo1001 */
                  10.64.0.175/32;
                  /* kafka-jumbo1002 */
                  10.64.0.176/32;
                  /* kafka1002 */
                  10.64.16.41/32;
                  /* kafka-jumbo1003 */
                  10.64.16.99/32;
                  /* kafka1003 */
                  10.64.32.127/32;
                  /* kafka-jumbo1004 */
                  10.64.32.159/32;
                  /* kafka-jumbo1005 */
                  10.64.32.160/32;
                  /* kafka-jumbo1006 */
                  10.64.48.117/32;
                  /* kafka2001 */
                  10.192.0.139/32;
                  /* kafka2002 */
                  10.192.16.169/32;
                  /* kafka2003 */
                  10.192.32.150/32;
              }
              protocol tcp;
              destination-port 9092-9093;
          }
          then accept;
      }
      term archiva {
          from {
              destination-address {
                  /* archiva1001 */
                  208.80.154.16/32;
              }
              protocol tcp;
              destination-port [ 80 443 873 ];
          }
          then accept;
      }
      term gerritssh {
          from {
              destination-address {
                  /* gerrit */
                  208.80.154.85/32;
              }
              protocol tcp;
              destination-port 29418;
          }
          then accept;
      }
      term gerrit--https {
          from {
              destination-address {
                  /* gerrit */
                  208.80.154.85/32;
              }
              protocol tcp;
              destination-port 443;
          }
          then accept;
      }
      term bacula {
          from {
              destination-address {
                  /* helium */
                  10.64.0.179/32;
              }
              protocol [ tcp udp ];
              destination-port 9103;
          }
          then accept;
      }
      term zookeeper {
          from {
              destination-address {
                  /* conf1001 */
                  10.64.0.18/32;
                  /* conf1004 */
                  10.64.0.23/32;
                  /* conf1005 */
                  10.64.16.29/32;
                  /* conf1002 */
                  10.64.32.180/32;
                  /* conf1003 */
                  10.64.48.111/32;
                  /* conf1006 */
                  10.64.48.167/32;
              }
              protocol tcp;
              destination-port 2181-2183;
          }
          then accept;
      }
      /*
       ** T107576
       */
      term labstore1003 {
          from {
              destination-address {
                  /* labstore1003 */
                  10.64.4.10/32;
              }
              protocol tcp;
              destination-port 873;
          }
          then accept;
      }
      term aqs {
          from {
              destination-address {
                  /* aqs1004 */
                  10.64.0.107/32;
                  /* aqs1004-a, aqs1004-b */
                  10.64.0.126/31;
                  /* aqs1007 */
                  10.64.0.199/32;
                  /* aqs1007-a */
                  10.64.0.213/32;
                  /* aqs1007-b */
                  10.64.0.237/32;
                  /* aqs1008 */
                  10.64.16.14/32;
                  /* aqs1008-a */
                  10.64.16.74/32;
                  /* aqs1008-b */
                  10.64.16.78/32;
                  /* aqs1005 */
                  10.64.32.138/32;
                  /* aqs1005-a */
                  10.64.32.189/32;
                  /* aqs1005-b */
                  10.64.32.190/32;
                  /* aqs1009 */
                  10.64.48.119/32;
                  /* aqs1009-a, aqs1009-b */
                  10.64.48.122/31;
                  /* aqs1006 */
                  10.64.48.146/32;
                  /* aqs1006-a, aqs1006-b */
                  10.64.48.148/31;
              }
              protocol tcp;
              destination-port 9042;
          }
          then accept;
      }
      term wdqs {
          from {
              destination-address {
                  /* wdqs1003 */
                  10.64.0.14/32;
                  /* wdqs1004 */
                  10.64.0.17/32;
                  /* wdqs1005 */
                  10.64.48.46/32;
                  /* wdqs2003 */
                  10.192.0.29/32;
                  /* wdqs2001 */
                  10.192.32.148/32;
                  /* wdqs2002 */
                  10.192.48.65/32;
              }
              protocol tcp;
              destination-port 8888;
          }
          then accept;
      }
      term icmp {
          from {
              protocol icmp;
          }
          then accept;
      }
      /*
       ** Revert this when we get a good queue to undo T120281 + see T198490
       */
      term es {
          from {
              destination-address {
                  /* elastic1051 */
                  10.64.32.21/32;
                  /* elastic1052 */
                  10.64.32.22/32;
                  /* elastic1017 */
                  10.64.48.39/32;
                  /* elastic2010 */
                  10.192.16.146/32;
                  /* elastic2035, elastic2036 */
                  10.192.48.74/31;
              }
              protocol tcp;
              destination-port [ 9200 9243 ];
          }
          then accept;
      }
      term druid {
          from {
              destination-address {
                  /* druid1004 */
                  10.64.0.35/32;
                  /* druid1005 */
                  10.64.16.172/32;
                  /* druid1006 */
                  10.64.48.171/32;
              }
              protocol tcp;
              destination-port [ 8081-8082 8090 ];
          }
          then accept;
      }
      /*
       ** T177821
       */
      term syslog {
          from {
              destination-address {
                  /* lithium */
                  10.64.32.154/32;
                  /* wezen */
                  10.192.48.64/32;
              }
              protocol udp;
              destination-port 514;
          }
          then accept;
      }
      /*
       ** T177821
       */
      term syslog-tls {
          from {
              destination-address {
                  /* lithium */
                  10.64.32.154/32;
                  /* wezen */
                  10.192.48.64/32;
              }
              protocol tcp;
              destination-port 6514;
          }
          then accept;
      }
      /*
       ** T191300
       */
      term debmonitor {
          from {
              destination-address {
                  /* debmonitor1001 */
                  10.64.32.62/32;
                  /* debmonitor2001 */
                  10.192.0.14/32;
              }
              protocol tcp;
              destination-port 443;
          }
          then accept;
      }
      term scap {
          from {
              destination-address {
                  /* deploy1001 */
                  10.64.32.16/32;
                  /* deploy2001 */
                  10.192.32.24/32;
              }
              protocol tcp;
              destination-port [ 80 443 ];
          }
          then accept;
      }
      term swift {
          from {
              destination-address {
                  /* swift.svc.codfw */
                  10.2.1.27/32;
                  /* swift.svc.eqiad */
                  10.2.2.27/32;
              }
              protocol tcp;
              destination-port 443;
          }
          then accept;
      }
      term schema {
          from {
              destination-address {
                  /* schema.svc.codfw */
                  10.2.1.43/32;
                  /* schema.svc.eqiad */
                  10.2.2.43/32;
              }
              protocol tcp;
              destination-port 8190;
          }
          then accept;
      }
      term kerberos {
          from {
              destination-address {
                  /* kerberos1001 */
                  10.64.0.182/32;
              }
              protocol [ tcp udp ];
              destination-port [ 88 464 ];
          }
          then accept;
      }
      term default {
          then {
              discard;
          }
      }
    }
    {% endif %}
    filter sandbox4 {
        term no-private {
            from {
                prefix-list {
                    private4;
                }
            }
            then {
                discard;
            }
        }
        term dns {
            from {
                protocol udp;
                destination-port 53;
            }
            then accept;
        }
        term vrrp {
            from {
                protocol [ vrrp ah ];
            }
            then accept;
        }
        term dhcp {
            from {
                protocol udp;
                destination-port dhcp;
            }
            then accept;
        }
        term icmp {
            from {
                protocol icmp;
            }
            then accept;
        }
        term reject_other_WMF_space {
            from {
                destination-prefix-list {
                    wikimedia4;
                }
            }
            then {
                discard;
            }
        }
        term allow_rest {
            then accept;
        }
    }
    filter vrrp-in4 {
        term allow-vrrp {
            from {
                destination-address {
                    224.0.0.18/32;
                }
                protocol [ vrrp ah ];
            }
            then accept;
        }
    }
    {% if site == "eqiad" %}
    filter labs-in4 {
        term allow-vrrp {
            filter vrrp-in4;
        }
        /* T190424 */
        term pxeboot--http {
            from {
                source-address {
                    10.64.20.0/24;
                }
                destination-address {
                    208.80.154.22/32;
                    208.80.153.53/32;
                }
                protocol tcp;
                destination-port 80;
            }
            then accept;
        }
        term ttl-check {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    10.64.20.0/24;
                }
                ttl-except 64;
            }
            then {
                count ttl-check;
                discard;
            }
        }
        term allow-labs {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    10.64.20.0/24;
                }
                destination-address {
                    /* labs-support1-a-eqiad */
                    10.64.4.0/24;
                    /* labs-hosts1-b-eqiad */
                    10.64.20.0/24;
                    /* labs-support1-c-eqiad */
                    10.64.37.0/24;
                }
            }
            then accept;
        }
        term allow-labs-instances {
            from {
                destination-address {
                    /* labs-instances1-b-eqiad */
                    10.68.16.0/21;
                }
            }
            then accept;
        }
        term puppetmaster {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    10.64.20.0/24;
                }
                destination-address {
                    /* puppetmaster1001 */
                    10.64.16.73/32;
                    /* puppetmaster2001 */
                    10.192.0.27/32;
                }
                protocol tcp;
                destination-port 8140;
            }
            then accept;
        }
        term prometheus {
            from {
                destination-address {
                    /* prometheus1003 */
                    10.64.0.123/32;
                    /* prometheus1004 */
                    10.64.16.38/32;
                    /* prometheus2003 */
                    10.192.0.145/32;
                    /* prometheus2004 */
                    10.192.16.189/32;
                }
                protocol tcp;
                source-port 9100;
            }
            then accept;
        }
        term cumin {
            from {
                source-address {
                    10.64.20.0/24;
                }
                destination-address {
                    /* cumin1001 */
                    10.64.32.25/32;
                    /* cumin2001 */
                    10.192.48.16/32;
                }
                protocol tcp;
                source-port 22;
            }
            then accept;
        }
        term labs_mysql {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    10.64.20.0/24;
                }
                destination-address {
                    /* db1009 */
                    10.64.0.13/32;
                    /* db1073 */
                    10.64.16.79/32;
                    /* db2037 */
                    10.192.32.8/32;
                }
                protocol tcp;
                destination-port 3306;
            }
            then accept;
        }
        term debmonitor {
            from {
                source-address {
                    10.64.20.0/24;
                }
                destination-address {
                    10.64.32.62/32;
                    10.192.0.14/32;
                }
                protocol tcp;
                destination-port 443;
            }
            then accept;
        }
        term allow_syslog {
            from {
                destination-address {
                    /* lithium */
                    10.64.32.154/32;
                    /* wezen */
                    10.192.48.64/32;
                }
                protocol udp;
                destination-port 514;
            }
            then accept;
        }
        term allow_syslog-tls {
            from {
                destination-address {
                    /* lithium */
                    10.64.32.154/32;
                    /* wezen */
                    10.192.48.64/32;
                }
                protocol tcp;
                destination-port 6514;
            }
            then accept;
        }
        term allow_graphite {
            from {
                source-address {
                    10.64.20.0/24;
                }
                destination-port [ 2003 2004 8125 ];
            }
            then accept;
        }
        term phab-git-ssh {
            from {
                destination-address {
                    /* git-ssh.eqiad.wikimedia.org */
                    208.80.154.250/32;
                    /* git-ssh.codfw.wikimedia.org */
                    208.80.153.250/32;
                }
                protocol tcp;
                destination-port 22;
            }
            then accept;
        }
        term no_ssh_public4 {
            from {
                destination-prefix-list {
                    wikimedia4;
                }
                destination-port ssh;
                tcp-initial;
            }
            then {
                reject;
            }
        }
        term inf-use-proxy {
            from {
                source-address {
                    10.64.20.0/24;
                }
                destination-address {
                    /* install1002 */
                    208.80.154.22/32;
                    /* install2002 */
                    208.80.153.53/32;
                }
                protocol tcp;
                destination-port [ 3128 8080 ];
            }
            then accept;
        }
        term instance-traffic {
            filter labs-instance-in4;
        }
        term default {
            filter deny-private-subnets-in4;
        }
    }
    /* Traffic from Labs instances can allow specifics here */
    filter labs-instance-in4 {
        term labstore {
            from {
                destination-address {
                    10.64.4.10/32;
                    10.64.37.6/32;
                    10.64.37.7/32;
                    10.64.37.10/32;
                    10.64.37.16/32;
                    10.64.37.17/32;
                    10.64.37.18/32;
                }
                protocol [ tcp udp ];
                port [ 38465-38567 55659 44153 111 2049 ];
            }
            then accept;
        }
        term labsdb-tcp4 {
            from {
                destination-address {
                    10.64.37.8/32;
                    10.64.37.9/32;
                    10.64.37.11/32;
                    10.64.37.12/32;
                    10.64.4.11/32;
                    10.64.37.14/32;
                    10.64.37.15/32;
                }
                protocol tcp;
                port [ 3306-3309 5432 873 ];
            }
            then accept;
        }
        term labmon {
            from {
                destination-address {
                    10.64.37.13/32;
                    10.64.4.15/32;
                }
                protocol [ tcp udp ];
                destination-port [ 80 8125 2003 2004 ];
            }
            then accept;
        }
       term relforge {
           from {
               destination-address {
                   10.64.4.13/32;
                   10.64.37.21/32;
               }
               protocol tcp;
               destination-port 9243;
           }
           then accept;
       }
    }
    {% endif %}
    {% if site == "eqiad" or site == "codfw"  %}
    /* Applied to cloud instance traffic going out of the cloud-instance-transport vlan. Last audit in T199435 and T211921. */
    filter cloud-in4 {
        interface-specific;
        term allow-icmp {
            from {
                source-address {
                    /* cloud-instance-transport1-b-codfw */
                    208.80.153.184/29;
                    /* cloud-instance-transport1-b-eqiad */
                    208.80.155.88/29;
                }
                protocol icmp;
            }
            then accept;
        }
        term vrrp {
            from {
                destination-address {
                    224.0.0.18/32;
                }
                protocol [ vrrp ah ];
            }
            then accept;
        }
        term labstore {
            from {
                destination-address {
                    /* labstore1003 */
                    10.64.4.10/32;
                    /* labstore1001, labstore1002 */
                    10.64.37.6/31;
                    /* labstore.svc */
                    10.64.37.10/32;
                    /* nfs-scratch.svc, nfs-tools-home */
                    10.64.37.16/31;
                    /* nfs-tools-project.svc */
                    10.64.37.18/32;
                }
                protocol [ tcp udp ];
                destination-port [ 111 2049 38466 ];
            }
            then accept;
        }
        /*
         ** labsdb100[4567] are being decommed - T193264
         */
        term labsdb {
            from {
                destination-address {
                    /* labsdb1004, labsdb1005 */
                    10.64.37.8/31;
                    /* labsdb1006 */
                    10.64.37.11/32;
                    /* labsdb1007 */
                    10.64.37.12/32;
                    /* dbproxy1010, dbproxy1011 */
                    10.64.37.14/31;
                }
                protocol tcp;
                destination-port [ 22 873 3306 5432 ];
            }
            then accept;
        }
        /*
         ** T216353
         */
        term clouddb_return {
            from {
                destination-address {
                    /* labsdb1004, labsdb1005 */
                    10.64.37.8/31;
                    /* labsdb1006 */
                    10.64.37.11/32;
                    /* labsdb1007 */
                    10.64.37.12/32;
                    /* dbproxy1010, dbproxy1011 */
                    10.64.37.14/31;
                    /* nfs-tools-project.svc, labstore1004 */
                    10.64.37.18/31;
                    /* labstore1005 */
                    10.64.37.20/32;
                }
                protocol tcp;
                source-port 3306;
            }
            then accept;
        }
        term labmon--http {
            from {
                destination-address {
                    /* labmon1002 */
                    10.64.4.15/32;
                    /* labmon1001 */
                    10.64.37.13/32;
                }
                protocol tcp;
                destination-port 80;
            }
            then accept;
        }
        term labmon--statsd {
            from {
                destination-address {
                    /* labmon1002 */
                    10.64.4.15/32;
                    /* labmon1001 */
                    10.64.37.13/32;
                }
                protocol udp;
                destination-port 8125;
            }
            then accept;
        }
        term labmon--graphite {
            from {
                destination-address {
                    /* labmon1002 */
                    10.64.4.15/32;
                    /* labmon1001 */
                    10.64.37.13/32;
                }
                protocol [ tcp udp ];
                destination-port 2003;
            }
            then accept;
        }
        term relforge {
            from {
                destination-address {
                    /* relforge1001 */
                    10.64.4.13/32;
                    /* relforge1002 */
                    10.64.37.21/32;
                }
                protocol tcp;
                destination-port 9243;
            }
            then accept;
        }
        term labnet-nova-api {
            from {
                destination-address {
                    /* labnet1001 */
                    10.64.20.13/32;
                }
                protocol tcp;
                destination-port 8774;
            }
            then accept;
        }
        /*
         ** Deny any communication with private subnets
         */
        term deny-private-subnets {
            from {
                destination-address {
                    10.0.0.0/8;
                    172.16.0.0/12;
                }
            }
            then {
                reject;
            }
        }
        /*
         ** Allow communication to public subnets and the Internet
         */
        term default {
            then accept;
        }
    }
    {% endif %}
}
family inet6 {
    filter border-in6 {
        term special-ranges {
            from {
                prefix-list {
                    special-ranges6;
                }
            }
            then {
                count special-ranges-in;
                discard;
            }
        }
        term allow_peers6 {
            from {
                source-prefix-list {
                    bgp-sessions;
                }
            }
            then accept;
        }
        term lvs-blackhole {
            from {
                source-prefix-list {
                    blackhole6;
                }
                destination-prefix-list {
                    LVS-service-ips6;
                }
            }
            then {
                discard;
            }
        }
        /* Deny outside traffic to our private IPv6 ranges */
        term our-private {
            from {
                destination-prefix-list {
                    private6;
                }
            }
            then {
                reject administratively-prohibited;
            }
        }
        /* reject traffic spoofed with our own source addresses */
        term own-space {
            from {
                source-prefix-list {
                    wikimedia6;
                }
            }
            then {
                count own-space;
                discard;
            }
        }
        term udp-lvs-ddos {
            from {
                destination-prefix-list {
                    LVS-service-ips6;
                }
                next-header udp;
            }
            then {
                discard;
            }
        }
        /* explicitly allow SSH traffic; would normally be discarded by the protect-lvs term below */
        term phab-git-ssh {
            from {
                destination-address {
                    /* git-ssh.eqiad.wikimedia.org */
                    2620:0:861:ed1a::3:16/128;
                    /* git-ssh.codfw.wikimedia.org */
                    2620:0:860:ed1a::3:fa/128;
                }
                next-header tcp;
                destination-port 22;
            }
            then accept;
        }
        term gre-lvs-ddos {
            from {
                destination-prefix-list {
                    LVS-service-ips6;
                }
                next-header gre;
            }
            then discard;
        }
        term protect-lvs {
            from {
                destination-prefix-list {
                    LVS-service-ips6;
                }
                next-header tcp;
                destination-port [ 22 179 9090 9100 ];
            }
            then {
                discard;
            }
        }
        /* RIPE Atlas wants access to 5666 which we block below */
        term ripe-atlas {
            from {
                destination-address {
                    2620:0:861:202:208:80:155:69/128;
                    2620:0:860:201:208:80:152:244/128;
                    2620:0:863:201:198:35:26:244/128;
                    2001:df2:e500:201:103:102:166:20/128;
                    2620:0:862:201:91:198:174:132/128;
                }
            }
            then accept;
        }
        /* reject webproxy for extra protection, as it's a gateway to prod - T122368 */
        term webproxy {
            from {
                destination-address {
                    /* install1002 */
                    2620:0:861:1:208:80:154:22;
                    /* install2002 */
                    2620:0:860:2:208:80:153:53;
                }
                next-header tcp;
                destination-port [ 3128 8080 ];
            }
            then reject administratively-prohibited;
        }
        term nrpe {
            from {
                next-header tcp;
                destination-port 5666;
            }
            then {
                reject administratively-prohibited;
            }
        }
        term default {
            then accept;
        }
    }
    filter border-out6 {
        term special-ranges {
            from {
                prefix-list {
                    special-ranges6;
                }
            }
            then {
                count special-ranges-out;
                discard;
            }
        }
        /* Deny outgoing traffic from private IPv6 ranges */
        term private {
            from {
                source-prefix-list {
                    private6;
                }
            }
            then {
                reject administratively-prohibited;
            }
        }
        term default {
            then accept;
        }
    }
    filter deny-private-subnets-in6 {
        /* Deny any communication with private subnets */
        term deny-private-subnets {
            from {
                destination-prefix-list {
                    private6;
                }
            }
            then {
                count deny-private-subnets-in6;
                log;
                reject administratively-prohibited;
            }
        }
        /* Allow communication to public subnets and the Internet */
        term default {
            then accept;
        }
    }
    filter loopback6 {
        term allow_ssh6 {
            from {
                source-prefix-list {
                    wikimedia6;
                    private6;
                    trusted-space6;
                }
                next-header tcp;
                destination-port ssh;
            }
            then accept;
        }
        term allow_bgp6 {
            from {
                source-prefix-list {
                    bgp-sessions;
                }
                next-header tcp;
                port bgp;
            }
            then accept;
        }
        term allow_ospf6 {
            from {
                next-header ospf;
            }
            then accept;
        }
        term allow_snmp6 {
            from {
                source-prefix-list {
                    wikimedia6;
                    private6;
                    trusted-space6;
                }
                next-header tcp;
                destination-port snmp;
            }
        }
        term allow_ntp6 {
            from {
                source-prefix-list {
                    wikimedia6;
                }
                next-header udp;
                destination-port ntp;
            }
            then accept;
        }
        term allow_ok_icmp6 {
            from {
                next-header icmpv6;
            }
            then accept;
        }
        term allow_vrrp6 {
            from {
                next-header vrrp;
            }
            then accept;
        }
        term allow_bfd6 {
            from {
                next-header udp;
                port 3784-3785;
            }
            then accept;
        }
        term allow_pim6 {
            from {
                next-header pim;
            }
            then accept;
        }
        term return-tcp {
            from {
                source-prefix-list {
                    wikimedia6;
                }
                next-header tcp;
                tcp-established;
            }
            then accept;
        }
        term deny_other {
            then discard;
        }
    }
    filter sandbox6 {
        term no-private {
            from {
                prefix-list {
                    private6;
                }
            }
            then discard;
        }
        term dns {
            from {
                next-header udp;
                destination-port 53;
            }
            then accept;
        }
        term vrrp {
            from {
                next-header [ vrrp ah ];
            }
            then accept;
        }
        term icmp {
            from {
                next-header icmp6;
            }
            then accept;
        }
        term reject_other_WMF_space {
            from {
                destination-prefix-list {
                    wikimedia6;
                }
            }
            then discard;
        }
        term allow_rest {
            then accept;
        }
    }
    filter vrrp-in6 {
        term allow_vrrp6 {
            from {
                next-header vrrp;
            }
            then accept;
        }
    }
    {% if site == "eqiad" %}
    filter labs-in6 {
        term allow-vrrp {
            filter vrrp-in6;
        }
        inactive: term ttl-check {
            from {
                source-address {
                    2620:0:861:118::/64;
                }
                hop-limit-except 64;
            }
            then {
                count ttl-check;
                discard;
            }
        }
        term allow-labs {
            from {
                source-address {
                    2620:0:861:118::/64;
                }
                destination-address {
                    2620:0:861:117::/64;
                    2620:0:861:118::/64;
                    2620:0:861:119::/64;
                }
            }
            then accept;
        }
        term puppetmaster {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    2620:0:861:118::/64;
                }
                destination-address {
                    /* puppetmaster1001 */
                    2620:0:861:102:10:64:16:73/128;
                    /* puppetmaster2001 */
                    2620:0:860:101:10:192:0:27/128;
                }
                next-header tcp;
                destination-port 8140;
            }
            then accept;
        }
        term phab-git-ssh {
            from {
                destination-address {
                    /* git-ssh.eqiad.wikimedia.org */
                    2620:0:861:ed1a::3:16/128;
                    /* git-ssh.codfw.wikimedia.org */
                    2620:0:860:ed1a::3:fa/128;
                }
                next-header tcp;
                destination-port 22;
            }
            then accept;
        }
        term prometheus {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    2620:0:861:118::/64;
                }
                destination-address {
                    /* prometheus1003 */
                    2620:0:861:101:10:64:0:123/128;
                    /* prometheus1004 */
                    2620:0:861:102:10:64:16:38/128;
                    /* prometheus2003 */
                    2620:0:860:101:10:192:0:145/128;
                    /* prometheus2004 */
                    2620:0:860:102:10:192:16:189/128;
                }
                next-header tcp;
                source-port 9100;
            }
            then accept;
        }
        term no_ssh_public6 {
            from {
                destination-prefix-list {
                    wikimedia6;
                }
                next-header tcp;
                destination-port ssh;
                tcp-initial;
            }
            then {
                reject;
            }
        }
        term default {
            filter deny-private-subnets-in6;
        }
    }
    /* Applied to traffic going out of the analytics vlans. Last audit in T198623. */
    filter analytics-in6 {
        interface-specific;
        term puppet {
            from {
                destination-address {
                    /* puppetmaster2001 */
                    2620:0:860:101:10:192:0:27/128;
                    /* puppetmaster1001 */
                    2620:0:861:102:10:64:16:73/128;
                    /* puppetmaster1002 */
                    2620:0:861:107:10:64:48:45/128;
                }
                next-header tcp;
                destination-port 8140;
            }
            then accept;
        }
        term apt {
            from {
                destination-address {
                    /* install2002 */
                    2620:0:860:2:208:80:153:53/128;
                    /* install1002 */
                    2620:0:861:1:208:80:154:22/128;
                }
                next-header tcp;
                destination-port 80;
            }
            then accept;
        }
        term webproxy {
            from {
                destination-address {
                    /* install2002 */
                    2620:0:860:2:208:80:153:53/128;
                    /* install1002 */
                    2620:0:861:1:208:80:154:22/128;
                }
                next-header tcp;
                destination-port 8080;
            }
            then accept;
        }
        term dns {
            from {
                next-header udp;
                destination-port 53;
            }
            then accept;
        }
        term ntp {
            from {
                next-header udp;
                destination-port 123;
            }
            then accept;
        }
        term smtp {
            from {
                next-header tcp;
                destination-port 25;
            }
            then accept;
        }
        term icinga {
            from {
                destination-address {
                    /* icinga2001 */
                    2620:0:860:3:208:80:153:74/128;
                    /* icinga1001 */
                    2620:0:861:3:208:80:154:84/128;
                }
            }
            then accept;
        }
        term igmp {
            from {
                next-header igmp;
            }
            then accept;
        }
        term pim {
            from {
                destination-address {
                    ff02::d/128;
                }
                next-header pim;
            }
            then accept;
        }
        term tftp {
            from {
                destination-address {
                    /* install2002 */
                    2620:0:860:2:208:80:153:53/128;
                    /* install1002 */
                    2620:0:861:1:208:80:154:22/128;
                }
                next-header udp;
                destination-port [ 69 32768-61000 ];
            }
            then accept;
        }
        term vrrp {
            from {
                next-header [ vrrp ah ];
            }
            then accept;
        }
        term dhcp {
            from {
                next-header udp;
                destination-port 67-68;
            }
            then accept;
        }
        term neighbor_discovery {
            from {
                destination-address {
                    ff02::/123;
                    ff02::1:ff00:0/104;
                }
            }
            then accept;
        }
        term analytics-subnets {
            from {
                destination-address {
                    /* analytics1-a-eqiad, analytics1-c-eqiad */
                    2620:0:861:104::/63;
                    /* analytics1-c-eqiad */
                    2620:0:861:106::/64;
                    /* analytics1-d-eqiad */
                    2620:0:861:108::/64;
                }
            }
            then accept;
        }
        term analytics-publicIP {
            from {
                destination-address {
                    /* dataset1001 */
                    2620:0:861:1:208:80:154:11/128;
                    /* install1002 */
                    2620:0:861:1:208:80:154:22/128;
                }
            }
            then accept;
        }
        term ssh {
            from {
                destination-address {
                    /* sodium */
                    2620:0:861:1:208:80:154:15/128;
                    /* aluminium, cobalt */
                    2620:0:861:3:208:80:154:80/127;
                }
                next-header tcp;
                destination-port 22;
            }
            then accept;
        }
        term rsync-http-https {
            from {
                destination-address {
                    /* sodium */
                    2620:0:861:1:208:80:154:15/128;
                    /* aluminium, cobalt */
                    2620:0:861:3:208:80:154:80/127;
                    /* eventlog1002 */
                    2620:0:861:107:10:64:48:95/128;
                }
                next-header tcp;
                destination-port [ 80 443 873 ];
            }
            then accept;
        }
        term return-tcp {
            from {
                next-header tcp;
                tcp-established;
            }
            then accept;
        }
        term kafka {
            from {
                destination-address {
                    /* kafka2001 */
                    2620:0:860:101:10:192:0:139/128;
                    /* kafka2002 */
                    2620:0:860:102:10:192:16:169/128;
                    /* kafka2003 */
                    2620:0:860:103:10:192:32:150/128;
                    /* kafka1001 */
                    2620:0:861:101:10:64:0:11/128;
                    /* kafka-jumbo1001 */
                    2620:0:861:101:10:64:0:175/128;
                    /* kafka-jumbo1002 */
                    2620:0:861:101:10:64:0:176/128;
                    /* kafka1002 */
                    2620:0:861:102:10:64:16:41/128;
                    /* kafka-jumbo1003 */
                    2620:0:861:102:10:64:16:99/128;
                    /* kafka1003 */
                    2620:0:861:103:10:64:32:127/128;
                    /* kafka-jumbo1004 */
                    2620:0:861:103:10:64:32:159/128;
                    /* kafka-jumbo1005 */
                    2620:0:861:103:10:64:32:160/128;
                    /* kafka-jumbo1006 */
                    2620:0:861:107:10:64:48:117/128;
                }
                next-header tcp;
                destination-port 9092-9093;
            }
            then accept;
        }
        term archiva {
            from {
                destination-address {
                    /* archiva1001 */
                    2620:0:861:1:208:80:154:16/128;
                }
                next-header tcp;
                destination-port [ 80 443 873 ];
            }
            then accept;
        }
        term gerritssh {
            from {
                destination-address {
                    /* gerrit */
                    2620:0:861:3:208:80:154:85/128;
                }
                next-header tcp;
                destination-port 29418;
            }
            then accept;
        }
        term gerrit--https {
            from {
                destination-address {
                    /* gerrit */
                    2620:0:861:3:208:80:154:85/128;
                }
                next-header tcp;
                destination-port 443;
            }
            then accept;
        }
        term zookeeper {
            from {
                destination-address {
                    /* conf1004 */
                    2620:0:861:101:10:64:0:23/128;
                    /* conf1005 */
                    2620:0:861:102:10:64:16:29/128;
                    /* conf1006 */
                    2620:0:861:107:10:64:48:167/128;
                }
                next-header tcp;
                destination-port 2181-2183;
            }
            then accept;
        }
        term icmp6 {
            from {
                next-header icmpv6;
            }
            then accept;
        }
        term druid {
            from {
                destination-address {
                    /* druid1004 */
                    2620:0:861:101:10:64:0:35/128;
                    /* druid1005 */
                    2620:0:861:102:10:64:16:172/128;
                    /* druid1006 */
                    2620:0:861:107:10:64:48:171/128;
                }
                next-header tcp;
                destination-port [ 8081-8082 8090 ];
            }
            then accept;
        }
        term scap {
            from {
                destination-address {
                    /* deploy2001 */
                    2620:0:860:103:10:192:32:24/128;
                    /* deploy1001 */
                    2620:0:861:103:10:64:32:16/128;
                }
                next-header tcp;
                destination-port [ 80 443 ];
            }
            then accept;
        }
        term default {
            then discard;
        }
    }
    {% endif %}
}
policer policer-1m {
    if-exceeding {
        bandwidth-limit 1m;
        burst-size-limit 100k;
    }
    then discard;
}
policer policer-2m {
    if-exceeding {
        bandwidth-limit 2m;
        burst-size-limit 500k;
    }
    then discard;
}
