{% if device_bgp is defined -%}

{% if device_bgp.anycast_neighbors is defined -%}
  {% set anycast_neighbors = device_bgp.anycast_neighbors -%}
  {% include "includes/bgp/anycast.conf" %}
{% endif -%}

{% if device_bgp.lvs_neighbors | d({}) %}
  {% set lvs_neighbors = device_bgp.lvs_neighbors -%}
  {% include "includes/bgp/pybal.conf" %}
{% endif %}

{% if device_bgp.k8s_neighbors | d({}) %}
  {% set k8s_neighbors = device_bgp.k8s_neighbors -%}
  {% include "includes/bgp/k8s.conf" %}
{% endif %}

{% if device_bgp.k8s_stage_neighbors | d({}) %}
  {% set k8s_stage_neighbors = device_bgp.k8s_stage_neighbors -%}
  {% include "includes/bgp/k8s_stage.conf" %}
{% endif %}

{% if device_bgp.k8s_mlserve_neighbors | d({})  %}
  {% set k8s_mlserve_neighbors = device_bgp.k8s_mlserve_neighbors -%}
  {% include "includes/bgp/k8s_mlserve.conf" %}
{% endif %}

{% if device_bgp.k8s_mlstaging_neighbors | d({})  %}
  {% set k8s_mlstaging_neighbors = device_bgp.k8s_mlstaging_neighbors -%}
  {% include "includes/bgp/k8s_mlstaging.conf" %}
{% endif %}

{% if device_bgp.k8s_dse_neighbors | d({})  %}
  {% set k8s_dse_neighbors = device_bgp.k8s_dse_neighbors -%}
  {% include "includes/bgp/k8s_dse.conf" %}
{% endif %}

{% if device_bgp.cr_neighbors is defined -%}
{% for ipversion in [4, 6] %}
group external{{ ipversion }} {
    type external;
    hold-time 30;
    import BGP_Default;
    family inet{{ ipversion | trim('4') }} {
        unicast {
            prefix-limit {
                maximum 1000;
                teardown;
            }
        }
    }
    export Ext_out{{ ipversion }};
    peer-as {{ asn }};
    {% for peer_name, ips in device_bgp.cr_neighbors.items() | sort () %}
    neighbor {{ ips[ipversion] }} {
        description {{ peer_name }};
    }
    {% endfor -%}
}
{% endfor -%}
{% endif -%}

{% endif -%}
