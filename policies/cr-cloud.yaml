filters:
  - header:
      comment: |-
        Applied to cloud instance traffic going out of the cloud-instance-transport vlan
        Last audit in T264993
      targets:
        juniper: cloud-in4 inet no-interface-specific
    terms:
      - name: allow-icmp-from-transport
        source-address: cloud-transports
        protocol: icmp
        action: accept
      - name: deny-from-transports
        source-address: cloud-transports
        action: reject
      - name: deny-from-cloud-private
        comment: |-
          Deny from physical-host cloud-private IP ranges (doesn't include VMs)
        source-address: cloud-private
        action: reject
      - name: deny-to-private
        destination-address: RFC1918
        action: reject
      - name: wiki--HTTP-S
        comment: |-
          This rule and remaining specific rules allow traffic directly from
          cloud VM instances in the 172.16/12 range to certain WMF public IPs - T209011
        destination-address: text-lb.eqiad upload-lb.eqiad text-lb.codfw upload-lb.codfw
          text-lb.ulsfo upload-lb.ulsfo text-lb.esams upload-lb.esams
          text-lb.eqsin upload-lb.eqsin text-lb.drmrs upload-lb.drmrs
        protocol: tcp
        destination-port: WEB
        action: accept
      - name: gerrit
        destination-address: gerrit.wikimedia.org gerrit-replica.wikimedia.org
        protocol: tcp
        destination-port: WEB gerritSSH
        action: accept
      - name: NFS
        comment: |-
          To be removed with T216422
        destination-address: clouddumps_group nfs-maps.wikimedia.org
        protocol: tcp
        destination-port: NFS
        action: accept
      - name: LDAP
        destination-address: ldap-ro.codfw.wikimedia.org ldap-ro.eqiad.wikimedia.org
        protocol: tcp
        destination-port: LDAP LDAPS
        action: accept
      - name: contint-ssh
        destination-address: contint_group
        protocol: tcp
        source-port: SSH
        action: accept
      - name: contint-gerrit
        destination-address: contint_group
        protocol: tcp
        destination-port: GIT
        action: accept
      - name: deny-from-instances
        comment: |-
          No more legit traffic from 172.16/12
        source-address: CLOUD_VMs
        action: deny
      - name: allow-from-public
        comment: |-
          Allow from cloud-public ranges, covering various public services, VM NAT ranges etc
        source-address: cloud-public
        action: accept
